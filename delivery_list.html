<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–ú–æ–∏ –¥–æ—Å—Ç–∞–≤–∫–∏</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background-color: var(--tg-theme-bg-color, #ffffff);
            color: var(--tg-theme-text-color, #000000);
            padding: 16px;
        }

        .container {
            max-width: 600px;
            margin: 0 auto;
        }

        h1 {
            font-size: 24px;
            margin-bottom: 20px;
            text-align: center;
        }

        .delivery-card {
            background-color: var(--tg-theme-secondary-bg-color, #f5f5f5);
            border-radius: 12px;
            padding: 16px;
            margin-bottom: 16px;
            border: 1px solid var(--tg-theme-hint-color, #e0e0e0);
        }

        .delivery-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
            padding-bottom: 12px;
            border-bottom: 1px solid var(--tg-theme-hint-color, #e0e0e0);
        }

        .delivery-id {
            font-weight: 600;
            font-size: 14px;
            color: var(--tg-theme-link-color, #3390ec);
        }

        .delivery-date {
            font-size: 13px;
            color: var(--tg-theme-hint-color, #999999);
        }

        .delivery-info {
            margin-bottom: 12px;
        }

        .info-row {
            display: flex;
            margin-bottom: 8px;
        }

        .info-label {
            font-weight: 500;
            min-width: 100px;
            color: var(--tg-theme-hint-color, #666666);
        }

        .info-value {
            flex: 1;
            font-weight: 600;
        }

        .editable-field {
            width: 100%;
            padding: 8px 12px;
            border: 2px solid var(--tg-theme-link-color, #3390ec);
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            background-color: var(--tg-theme-bg-color, #ffffff);
            color: var(--tg-theme-text-color, #000000);
        }

        .comment {
            background-color: #fff3cd;
            color: #856404;
            padding: 10px;
            border-radius: 8px;
            margin: 12px 0;
            font-size: 13px;
        }

        .btn-complete {
            width: 100%;
            padding: 14px;
            background-color: #4CAF50;
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            margin-top: 8px;
        }

        .btn-complete:active {
            background-color: #45a049;
        }

        .empty-state {
            text-align: center;
            padding: 40px 20px;
            color: var(--tg-theme-hint-color, #999999);
        }

        .empty-state-icon {
            font-size: 48px;
            margin-bottom: 16px;
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: var(--tg-theme-hint-color, #999999);
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üì¶ –ú–æ–∏ –¥–æ—Å—Ç–∞–≤–∫–∏</h1>

        <div id="loading" class="loading">
            –ó–∞–≥—Ä—É–∑–∫–∞...
        </div>

        <div id="deliveries-container"></div>

        <div id="empty-state" class="empty-state" style="display: none;">
            <div class="empty-state-icon">‚úÖ</div>
            <p>–ù–µ—Ç –∞–∫—Ç–∏–≤–Ω—ã—Ö –¥–æ—Å—Ç–∞–≤–æ–∫</p>
        </div>
    </div>

    <script>
        const tg = window.Telegram.WebApp;
        tg.expand();

        // –ü–æ–ª—É—á–∞–µ–º –¥–∞–Ω–Ω—ã–µ –æ—Ç –±–æ—Ç–∞ —á–µ—Ä–µ–∑ initDataUnsafe
        let deliveries = [];

        // –ü—ã—Ç–∞–µ–º—Å—è –ø–æ–ª—É—á–∏—Ç—å –¥–∞–Ω–Ω—ã–µ –æ—Ç –±–æ—Ç–∞
        try {
            const initData = tg.initDataUnsafe;
            console.log('InitData:', initData);
            
            // –î–∞–Ω–Ω—ã–µ –º–æ–≥—É—Ç –±—ã—Ç—å –ø–µ—Ä–µ–¥–∞–Ω—ã —á–µ—Ä–µ–∑ query_string
            if (initData && initData.query_string) {
                deliveries = JSON.parse(initData.query_string);
            }
        } catch (e) {
            console.error('–û—à–∏–±–∫–∞ –ø–∞—Ä—Å–∏–Ω–≥–∞ –¥–∞–Ω–Ω—ã—Ö:', e);
        }

        // –í–†–ï–ú–ï–ù–ù–û: –ï—Å–ª–∏ –¥–∞–Ω–Ω—ã—Ö –Ω–µ—Ç - –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —Ç–µ—Å—Ç–æ–≤—ã–µ
        if (deliveries.length === 0) {
            console.log('–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –æ—Ç –±–æ—Ç–∞, –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —Ç–µ—Å—Ç–æ–≤—ã–µ');
            // –ü—Ä–∏–º–µ—Ä –¥–∞–Ω–Ω—ã—Ö –¥–ª—è —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏
            deliveries = [
                {
                    buffer_id: 1,
                    date: '2025-12-07',
                    client: '–ò–≤–∞–Ω –ü–µ—Ç—Ä–æ–≤',
                    pair: 'RUB/EURO',
                    vydano: 1000,
                    courier_comment: '–ê–¥—Ä–µ—Å: —É–ª. –õ–µ–Ω–∏–Ω–∞ 10, –∫–≤. 5. –ü–æ–∑–≤–æ–Ω–∏—Ç—å –∑–∞ 30 –º–∏–Ω—É—Ç.'
                },
                {
                    buffer_id: 2,
                    date: '2025-12-07',
                    client: '–ú–∞—Ä–∏—è –°–∏–¥–æ—Ä–æ–≤–∞',
                    pair: 'USDT/EURO',
                    vydano: 500,
                    courier_comment: ''
                }
            ];
        }

        function renderDeliveries() {
            const container = document.getElementById('deliveries-container');
            const loading = document.getElementById('loading');
            const emptyState = document.getElementById('empty-state');

            loading.style.display = 'none';

            if (deliveries.length === 0) {
                emptyState.style.display = 'block';
                return;
            }

            container.innerHTML = '';

            deliveries.forEach(delivery => {
                const card = createDeliveryCard(delivery);
                container.appendChild(card);
            });
        }

        function createDeliveryCard(delivery) {
            const card = document.createElement('div');
            card.className = 'delivery-card';

            // –û–ø—Ä–µ–¥–µ–ª—è–µ–º –≤–∞–ª—é—Ç—É –≤—ã—Ö–æ–¥–∞ –∏–∑ –ø–∞—Ä—ã
            const pair = delivery.pair || '';
            const currencyOut = pair.split('/')[1] || 'EUR';

            card.innerHTML = `
                <div class="delivery-header">
                    <div class="delivery-id">–î–æ—Å—Ç–∞–≤–∫–∞ #${delivery.buffer_id}</div>
                    <div class="delivery-date">${delivery.date}</div>
                </div>

                <div class="delivery-info">
                    <div class="info-row">
                        <div class="info-label">–ö–ª–∏–µ–Ω—Ç:</div>
                        <div class="info-value">${delivery.client || 'N/A'}</div>
                    </div>

                    <div class="info-row">
                        <div class="info-label">–í–∞–ª—é—Ç–∞:</div>
                        <div class="info-value">${currencyOut}</div>
                    </div>

                    <div class="info-row">
                        <div class="info-label">–í—ã–¥–∞—Ç—å:</div>
                        <div class="info-value">
                            <input 
                                type="number" 
                                class="editable-field" 
                                value="${delivery.vydano}" 
                                step="0.01"
                                id="vydano-${delivery.buffer_id}"
                            >
                        </div>
                    </div>
                </div>

                ${delivery.courier_comment ? `
                    <div class="comment">
                        üí¨ –ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π: ${delivery.courier_comment}
                    </div>
                ` : ''}

                <button 
                    class="btn-complete" 
                    onclick="completeDelivery(${delivery.buffer_id})"
                >
                    ‚úÖ –í—ã–ø–æ–ª–Ω–µ–Ω–æ
                </button>
            `;

            return card;
        }

        function completeDelivery(bufferId) {
            const vydanoInput = document.getElementById(`vydano-${bufferId}`);
            const updatedVydano = parseFloat(vydanoInput.value);

            if (isNaN(updatedVydano) || updatedVydano <= 0) {
                alert('–í–≤–µ–¥–∏—Ç–µ –∫–æ—Ä—Ä–µ–∫—Ç–Ω—É—é —Å—É–º–º—É');
                return;
            }

            // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –¥–∞–Ω–Ω—ã–µ –±–æ—Ç—É
            const data = {
                action: 'complete_delivery',
                buffer_id: bufferId,
                updated_vydano: updatedVydano
            };

            tg.sendData(JSON.stringify(data));
        }

        // –†–µ–Ω–¥–µ—Ä–∏–º –¥–æ—Å—Ç–∞–≤–∫–∏ —Å—Ä–∞–∑—É
        renderDeliveries();

        tg.ready();
    </script>
</body>
</html>
