<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–í–µ—Ä–∏—Ñ–∏–∫–∞—Ü–∏—è –ø–æ–ø–æ–ª–Ω–µ–Ω–∏–π</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background-color: var(--tg-theme-bg-color, #ffffff);
            color: var(--tg-theme-text-color, #000000);
            padding: 16px;
        }

        .container {
            max-width: 600px;
            margin: 0 auto;
        }

        h1 {
            font-size: 24px;
            margin-bottom: 20px;
            text-align: center;
        }

        .request-card {
            background-color: var(--tg-theme-secondary-bg-color, #f5f5f5);
            border-radius: 12px;
            padding: 16px;
            margin-bottom: 16px;
            border: 1px solid var(--tg-theme-hint-color, #e0e0e0);
        }

        .request-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
            padding-bottom: 12px;
            border-bottom: 1px solid var(--tg-theme-hint-color, #e0e0e0);
        }

        .request-id {
            font-weight: 600;
            font-size: 14px;
            color: var(--tg-theme-link-color, #3390ec);
        }

        .request-date {
            font-size: 13px;
            color: var(--tg-theme-hint-color, #999999);
        }

        .request-info {
            margin-bottom: 16px;
        }

        .info-row {
            display: flex;
            justify-content: space-between;
            margin-bottom: 8px;
        }

        .info-label {
            font-weight: 500;
            color: var(--tg-theme-hint-color, #666666);
        }

        .info-value {
            font-weight: 600;
        }

        .amount {
            font-size: 24px;
            color: #4CAF50;
            text-align: center;
            margin: 16px 0;
        }

        .buttons {
            display: flex;
            gap: 12px;
        }

        .btn {
            flex: 1;
            padding: 14px;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
        }

        .btn-approve {
            background-color: #4CAF50;
            color: white;
        }

        .btn-approve:active {
            background-color: #45a049;
        }

        .btn-reject {
            background-color: #f44336;
            color: white;
        }

        .btn-reject:active {
            background-color: #da190b;
        }

        .reject-reason {
            margin-top: 12px;
            display: none;
        }

        .reject-reason textarea {
            width: 100%;
            padding: 12px;
            border: 1px solid var(--tg-theme-hint-color, #cccccc);
            border-radius: 8px;
            font-size: 14px;
            min-height: 80px;
            resize: vertical;
            background-color: var(--tg-theme-bg-color, #ffffff);
            color: var(--tg-theme-text-color, #000000);
        }

        .reject-reason button {
            margin-top: 8px;
        }

        .empty-state {
            text-align: center;
            padding: 40px 20px;
            color: var(--tg-theme-hint-color, #999999);
        }

        .empty-state-icon {
            font-size: 48px;
            margin-bottom: 16px;
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: var(--tg-theme-hint-color, #999999);
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>‚úÖ –í–µ—Ä–∏—Ñ–∏–∫–∞—Ü–∏—è –ø–æ–ø–æ–ª–Ω–µ–Ω–∏–π</h1>

        <div id="loading" class="loading">
            –ó–∞–≥—Ä—É–∑–∫–∞...
        </div>

        <div id="requests-container"></div>

        <div id="empty-state" class="empty-state" style="display: none;">
            <div class="empty-state-icon">‚úÖ</div>
            <p>–ù–µ—Ç –æ–∂–∏–¥–∞—é—â–∏—Ö –∑–∞–ø—Ä–æ—Å–æ–≤</p>
        </div>
    </div>

    <script>
        const tg = window.Telegram.WebApp;
        tg.expand();

        let requests = [];

        // –ü—ã—Ç–∞–µ–º—Å—è –ø–æ–ª—É—á–∏—Ç—å –¥–∞–Ω–Ω—ã–µ –æ—Ç –±–æ—Ç–∞
        try {
            const initData = tg.initDataUnsafe;
            console.log('InitData:', initData);
            
            if (initData && initData.query_string) {
                requests = JSON.parse(initData.query_string);
            }
        } catch (e) {
            console.error('–û—à–∏–±–∫–∞ –ø–∞—Ä—Å–∏–Ω–≥–∞ –¥–∞–Ω–Ω—ã—Ö:', e);
        }

        // –í–†–ï–ú–ï–ù–ù–û: –ï—Å–ª–∏ –¥–∞–Ω–Ω—ã—Ö –Ω–µ—Ç - –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —Ç–µ—Å—Ç–æ–≤—ã–µ
        if (requests.length === 0) {
            console.log('–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –æ—Ç –±–æ—Ç–∞, –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —Ç–µ—Å—Ç–æ–≤—ã–µ');
            requests = [
                {
                    request_id: 1,
                    username: 'sibarit8',
                    summa: 1000,
                    created_at: '2025-12-07T14:30:00'
                },
                {
                    request_id: 2,
                    username: 'miguel8517',
                    summa: 500,
                    created_at: '2025-12-07T15:45:00'
                }
            ];
        }

        function renderRequests() {
            const container = document.getElementById('requests-container');
            const loading = document.getElementById('loading');
            const emptyState = document.getElementById('empty-state');

            loading.style.display = 'none';

            if (requests.length === 0) {
                emptyState.style.display = 'block';
                return;
            }

            container.innerHTML = '';

            requests.forEach(request => {
                const card = createRequestCard(request);
                container.appendChild(card);
            });
        }

        function createRequestCard(request) {
            const card = document.createElement('div');
            card.className = 'request-card';

            card.innerHTML = `
                <div class="request-header">
                    <div class="request-id">–ó–∞–ø—Ä–æ—Å #${request.request_id}</div>
                    <div class="request-date">${formatDate(request.created_at)}</div>
                </div>

                <div class="request-info">
                    <div class="info-row">
                        <div class="info-label">–û—Ç:</div>
                        <div class="info-value">@${request.username}</div>
                    </div>

                    <div class="amount">
                        üí∞ ${request.summa.toFixed(2)} EUR
                    </div>
                </div>

                <div class="buttons">
                    <button 
                        class="btn btn-approve" 
                        onclick="approveRequest(${request.request_id})"
                    >
                        ‚úÖ –ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å
                    </button>
                    <button 
                        class="btn btn-reject" 
                        onclick="toggleRejectReason(${request.request_id})"
                    >
                        ‚ùå –û—Ç–∫–ª–æ–Ω–∏—Ç—å
                    </button>
                </div>

                <div id="reject-reason-${request.request_id}" class="reject-reason">
                    <textarea 
                        id="reason-${request.request_id}" 
                        placeholder="–£–∫–∞–∂–∏—Ç–µ –ø—Ä–∏—á–∏–Ω—É –æ—Ç–∫–ª–æ–Ω–µ–Ω–∏—è..."
                    ></textarea>
                    <button 
                        class="btn btn-reject" 
                        onclick="rejectRequest(${request.request_id})"
                    >
                        –û—Ç–∫–ª–æ–Ω–∏—Ç—å —Å –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–µ–º
                    </button>
                </div>
            `;

            return card;
        }

        function formatDate(isoString) {
            const date = new Date(isoString);
            return date.toLocaleString('ru-RU', {
                day: '2-digit',
                month: '2-digit',
                year: 'numeric',
                hour: '2-digit',
                minute: '2-digit'
            });
        }

        function toggleRejectReason(requestId) {
            const reasonDiv = document.getElementById(`reject-reason-${requestId}`);
            if (reasonDiv.style.display === 'none' || !reasonDiv.style.display) {
                reasonDiv.style.display = 'block';
            } else {
                reasonDiv.style.display = 'none';
            }
        }

        function approveRequest(requestId) {
            const data = {
                action: 'approve_cash_request',
                request_id: requestId
            };

            tg.sendData(JSON.stringify(data));
        }

        function rejectRequest(requestId) {
            const reasonInput = document.getElementById(`reason-${requestId}`);
            const reason = reasonInput.value.trim();

            if (!reason) {
                alert('–£–∫–∞–∂–∏—Ç–µ –ø—Ä–∏—á–∏–Ω—É –æ—Ç–∫–ª–æ–Ω–µ–Ω–∏—è');
                return;
            }

            const data = {
                action: 'reject_cash_request',
                request_id: requestId,
                reason: reason
            };

            tg.sendData(JSON.stringify(data));
        }

        // –†–µ–Ω–¥–µ—Ä–∏–º –∑–∞–ø—Ä–æ—Å—ã —Å—Ä–∞–∑—É
        renderRequests();

        tg.ready();
    </script>
</body>
</html>
